<html lang="en-US">
	<head>
		<meta charset="UTF-8">
		<script src="lib/jquery-3.5.1.min.js"></script>
		<script>
			const pokeApiBaseUrl = "https://pokeapi.co/api/v2/";
			let poke = [];
			
			$(document).ready(function() {
				console.log("on ready");
				$.get(pokeApiBaseUrl + "generation", function(response) {
					let rows = [];
					for(let i = 0; i < response.results.length; i++) {
						let genNum = getNumFromUrl(response.results[i].url);
						let splitName = response.results[i].name.split("-");
						
						//Create the tags for generations obtained from the api
						let row = document.createElement("tr");
						let col = document.createElement("td");
						let cbx = document.createElement("input");
						cbx.type = "checkbox";
						cbx.id = "gen" + genNum + "Check";
						$(cbx).attr("genNum", genNum);
						let label = document.createElement("label");
						$(label).attr("for", cbx.id);
						label.innerText = capitalizeFirstLetter(splitName[0]) + " " + splitName[1].toUpperCase();
						
						//Append the elements to each other leaving the row as base element
						$(row).append(col);
						let jqCol = $(col);
						jqCol.append(cbx);
						jqCol.append(label);
						rows.push(row);
					}
					//Add the rows to the generation selection modal
					$("#genCheckboxes").append(rows);
					
					$("#genModal").show();
					$("#loadingModal").hide();
				});
			});
			
			function handleLoadGensClick() {
				let selectedGens = [];
				$("#genCheckboxes [type=checkbox]:checked").each(function(index, genBox) {
					selectedGens.push(+$(genBox).attr("genNum"));
				});
				if(selectedGens.length > 0) {
					$("#loadingModal").show();
					loadPokemonFromGens(selectedGens);
				}
			}
			
			function loadPokemonFromGens(genNums) {
				let received = 0;
				poke = [];
				for(let i = 0; i < genNums.length; i++) {
					$.get(pokeApiBaseUrl + "generation/" + genNums[i] + "/", function(response) {
						console.log(response);
						poke.push(...response.pokemon_species);
						
						received++;
						if(received === genNums.length) {
							poke.sort(function(a, b){
								var numA = getNumFromUrl(a.url);
								var numB = getNumFromUrl(b.url);
								return numA - numB;
							});
							$("#genModal").hide();
							$("#loadingModal").hide();
							refreshContainer();
						}
					});
				}
			}
			
			function refreshContainer() {
				let mainContainer = $("#mainContainer");
				mainContainer.children().detach()
				for(let i = 0; i < poke.length; i++) {
					let item = document.createElement("li");
					item.innerHTML = poke[i].name;
					mainContainer.append(item);
				}
			}
			
			function getNumFromUrl(url) {
				let rx = /(\d+)\/$/
				return rx.exec(url)[1];
			}
			
			function capitalizeFirstLetter(string) {
				return string.charAt(0).toUpperCase() + string.slice(1);
			}
		</script>
		<link rel="stylesheet" href="assets/main.css">
	</head>
	<body>
		<div class="spinnerBox" id="loadingModal">
			<div class="modalBg"></div>
			<img src="assets/Ball.PNG" alt="Loading..." class="spinner"></img>
		</div>
		<div class="modalBox" id="genModal" style="display: none;">
			<div class="modalBg"></div>
			<div class="genSelectBox">
				Select generations to load
				
				<table id="genCheckboxes">
					<!-- Here will appear the generations after loading -->
				</table>
				
				<button onclick="handleLoadGensClick()">Load!</button>
			</div>
		</div>
		list
		<ul id="mainContainer">
			
		</ul>
	</body>
</html>