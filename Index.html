<html lang="en-US">
	<head>
		<meta charset="UTF-8">
		<script src="lib/jquery-3.5.1.min.js"></script>
		
		<script src="assets/pokeApiParsing.js"></script>
		<script>
			const LAST_SESSION_KEY = "lastSession";
			let pokeById;
			let pokeByName = {};
			
			$(document).ready(function() {
				$(".mainModal").hide();
				//==========
				if(!window.localStorage.getItem(LAST_SESSION_KEY)) {
					$("#prevSessionBtn").hide()
				}
				//===========
				console.log("on ready");
				loadGens(function(gens) {
					let rows = [];
					for(let i = 0; i < gens.length; i++) {
						//Create the tags for generations obtained from the api
						let row = document.createElement("tr");
						let col = document.createElement("td");
						let cbx = document.createElement("input");
						cbx.type = "checkbox";
						cbx.id = "gen" + gens[i].genNum + "Check";
						$(cbx).attr("genNum", gens[i].genNum);
						let label = document.createElement("label");
						$(label).attr("for", cbx.id);
						label.innerText = gens[i].genName;
						
						//Append the elements to each other leaving the row as base element
						$(row).append(col);
						let jqCol = $(col);
						jqCol.append(cbx);
						jqCol.append(label);
						rows.push(row);
					}
					//Add the rows to the generation selection modal
					$("#genCheckboxes").append(rows);
					
					$("#genModal").show();
					$("#loadingModal").hide();
				});
			});
			
			//onbeforeunload
			$(window).on("unload", function() {
				//Save session as last session.
				if(pokeById) {
					window.localStorage.setItem(LAST_SESSION_KEY, JSON.stringify(pokeById));
				}
			});
			
			function handleLoadGensClick() {
				let selectedGens = [];
				$("#genCheckboxes [type=checkbox]:checked").each(function(index, genBox) {
					selectedGens.push(+$(genBox).attr("genNum"));
				});
				if(selectedGens.length > 0) {
					$("#loadingModal").show();
					loadPokemonFromGens(selectedGens, refreshContainer);
				}
			}
			
			function handleLoadPrevSession() {
				refreshContainer(JSON.parse(window.localStorage.getItem(LAST_SESSION_KEY)));
			}
			
			function refreshContainer(loadedPoke) {
				pokeById = loadedPoke;
				let pokeContainer = $("#pokeContainer");
				
				pokeContainer.children().detach()
				
				let isPar = false;
				for (const id in pokeById) {
					if (pokeById.hasOwnProperty(id)) {
						let row = createPokeRow(pokeById[id]);
						
						if(isPar) {
							row.className = "pokeRowPar";
						}
						isPar = !isPar;
						pokeByName[pokeById[id].name] = {
							id: id,
							jqRow: $(row)
						};
						
						pokeContainer.append(row);
					}
				}
				$("#genModal").hide();
				$(".mainModal").show();
				$("#loadingModal").hide();
			}
			
			function createPokeRow(poke) {
				let row = document.createElement("div");
				let pokeAmount = 0;
				if(poke.obtainedAmount) {
					pokeAmount = +poke.obtainedAmount;
				}
				
				//Image
				let imgTd = document.createElement("span");
				imgTd.className = "pokeRowPart";
				
				let img = document.createElement("img");
				img.src = poke.spriteUrl;
				if(!pokeAmount) {
					img.className = "inactive";
				}
				imgTd.append(img);
				
				//Name text
				let nameTd = document.createElement("span");
				nameTd.className = "pokeRowPart pokeName";
				nameTd.innerHTML = poke.name;
				
				//Amount input
				let amountTd = document.createElement("span");
				amountTd.className = "pokeRowPart";
				
				let amountInput = document.createElement("input");
				amountInput.type = "number";
				amountInput.min = 0;
				amountInput.value = pokeAmount;
				amountInput.onchange = onAmountChangeBuilder(poke);
				amountTd.append(amountInput);
				
				
				row.append(imgTd);
				row.append(nameTd);
				row.append(amountTd);
				
				return row;
			}
			
			function onAmountChangeBuilder(poke) {
				return function() {
					let row = pokeByName[poke.name].jqRow;
					let img = row.find("img");
					let val = row.find("input").val()
					poke.obtainedAmount = val;
					if(val > 0) {
						img.removeClass("inactive");
					}
					else {
						img.addClass("inactive");
					}
				}
			}
			
			function onFilterChange() {//TODO
				const filterOptions = {
					searchTxt : $("#searchTxt").val().toLowerCase(),
					isSearchEmpty : searchTxt == "",
					hideObtained : $("#chkHideObtained").prop("checked")
				};
				
				let filterFunction = prepareFilterFunction(filterOptions);
				
				let isPar = false;
				for(const name in pokeByName) {
					if(filterFunction(name)) {
						let row = pokeByName[name].jqRow;
						row.show();
						
						if(isPar) {
							row.addClass("pokeRowPar");
						}
						else {
							row.removeClass("pokeRowPar");
						}
						isPar = !isPar;
					}
					else {
						pokeByName[name].jqRow.hide();
					}
				}
			}
			
			function prepareFilterFunction(filterOptions) {
				let result;
				let checkName = function(name) {
					return name.toLowerCase().search(filterOptions.searchTxt) >= 0;
				};
				let isObtained = function(name) {
					return !+(pokeById[pokeByName[name].id].obtainedAmount);
				}
				
				if(filterOptions.hideObtained) {
					if(filterOptions.isSearchEmpty) {
						result = function(name) {
							return isObtained(name);
						};
					}
					else {
						result = function(name) {
							return isObtained(name) && checkName(name);
						};
					}
				}
				else if(filterOptions.isSearchEmpty) {
					result = function() {
						return true;
					};
				}
				else {
					result = checkName;
				}
				
				return result;
			}
		</script>
		<link rel="stylesheet" href="assets/main.css">
	</head>
	<body>
		<!-- ================================ -->
		<div class="spinnerBox" id="loadingModal">
			<div class="modalBg"></div>
			<img src="assets/Ball.PNG" alt="Loading..." class="spinner"></img>
		</div>
		<!-- ================================ -->
		<div class="modalBox" id="genModal" style="display: none;">
			<div class="modalBg"></div>
			<div class="genSelectBox">
				Select generations to load
				
				<table id="genCheckboxes">
					<!-- Here will appear the generations after loading -->
				</table>
				
				<button onclick="handleLoadGensClick()">Load!</button>
				<button onclick="handleLoadPrevSession()" id="prevSessionBtn">Load previous session</button>
			</div>
		</div>
		<!-- ================================ -->
		<div class="mainModal">
			<div class="tableContainer">
				<div class="tableHeaderRow">
					<span style="padding: 2em;" class="tableHeader">Pokemon species</span>
					<span>
						<input id="searchTxt" type="text" placeholder="Search..." onkeyup="onFilterChange()"></input>
						<input id="chkHideObtained" type="checkbox" onchange="onFilterChange()"></input>
						<label for="chkHideObtained">Hide obtained pokemon</label>
					</span>
				</div>
				<div id="pokeContainer" class="pokeContainer">
					
				</div>
			</div>
		</div>
	</body>
</html>